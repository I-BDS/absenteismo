<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Absente√≠smo - Cloud Optimized</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3589/3589030.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3589/3589030.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/PptxGenJS@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .cell-falta { background-color: #fecaca; border: 1px solid #f87171; }
        .cell-atestado { background-color: #a7f3d0; border: 1px solid #34d399; }
        .cell-declaracao { background-color: #fef08a; border: 1px solid #facc15; }
        .cell-meio { background-color: #bfdbfe; border: 1px solid #60a5fa; }
        .tab-content { transition: all 0.3s ease-in-out; }
        .grid-calendar::-webkit-scrollbar { height: 8px; }
        .grid-calendar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }
        .uppercase-input { text-transform: uppercase; }

        .brand-title {
            color: #f8fafc;
            font-weight: 300;
            letter-spacing: 0.4em;
            font-size: 1.1rem;
            border-left: 1px solid #334155;
            padding-left: 1.5rem;
        }

        .nav-btn {
            position: relative;
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: color 0.3s;
        }
        .nav-active { color: #ffffff; }
        .nav-active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background-color: #3b82f6;
            border-radius: 2px;
        }

        #customToast {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: translateY(100px);
            opacity: 0;
        }
        #customToast.show { transform: translateY(0); opacity: 1; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 0.75rem !important; letter-spacing: 0.2em; padding-left: 1rem; }
            .grid-calendar table { font-size: 10px; }
            .kpi-card h4 { font-size: 1.5rem; }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <div id="customToast" class="fixed bottom-5 right-5 z-[200] flex items-center bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl border border-slate-700">
        <span id="toastMsg">Sincronizando...</span>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[160] p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </div>
            <h3 class="text-xl font-bold mb-2">Remover Colaborador?</h3>
            <p class="text-slate-500 text-sm mb-6">Esta a√ß√£o remover√° o colaborador e todo o hist√≥rico vinculado a ele no banco de dados.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 font-bold text-slate-500">Cancelar</button>
                <button id="confirmDeleteBtn" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200">Excluir</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[150] p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <div class="text-center">
                <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m0 0v2m0-2h2m-2 0h-2m8-3V7a4 4 0 00-8 0v4M5 11h14a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2z"/></svg>
                </div>
                <h3 class="text-xl font-bold mb-2">√Årea Restrita</h3>
                <p class="text-slate-500 text-sm mb-6">Digite a senha para limpar o hist√≥rico do per√≠odo.</p>
                <input type="password" id="inputSenha" class="w-full text-center border-2 p-3 rounded-xl mb-6 outline-none text-xl tracking-widest" placeholder="****">
                <div class="flex gap-3">
                    <button onclick="closePasswordModal()" class="flex-1 py-3 font-bold text-slate-500">Cancelar</button>
                    <button onclick="verifyAndClear()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-slate-900 p-4 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="brand-title uppercase font-light">Absente√≠smo</h1>
            <div class="flex items-center space-x-4">
                <button id="btn-tab-main" onclick="showTab('main')" class="nav-btn nav-active">Dashboard</button>
                <button id="btn-tab-colaboradores" onclick="showTab('colaboradores')" class="nav-btn">Equipe</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-6">
        <div id="main" class="tab-content">
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                <div class="flex flex-col xl:flex-row xl:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-black text-slate-800" id="periodoLabel">Vis√£o Geral</h2>
                        <p class="text-slate-500 text-xs mt-1 italic uppercase">Controle de Frequ√™ncia</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="searchName" oninput="buildCalendar()" placeholder="Buscar..." class="flex-grow sm:flex-none px-4 py-2 bg-slate-50 border rounded-xl text-sm outline-none w-full sm:w-40">
                        <select id="filterSector" onchange="buildCalendar()" class="px-3 py-2 bg-slate-50 border rounded-xl text-sm outline-none w-full sm:w-auto"></select>
                        <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-xl border w-full sm:w-auto">
                            <input type="date" id="filterStart" onchange="buildCalendar()" class="bg-transparent text-xs font-bold outline-none">
                            <input type="date" id="filterEnd" onchange="buildCalendar()" class="bg-transparent text-xs font-bold outline-none">
                        </div>
                        <button onclick="resetDashFilters()" class="bg-slate-200 p-2.5 rounded-xl"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                        <div class="flex gap-1">
                            <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-3 py-2 rounded-xl text-xs font-bold">Excel</button>
                            <button onclick="exportToPPT()" class="bg-orange-600 text-white px-3 py-2 rounded-xl text-xs font-bold">PPTX</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-xl overflow-hidden mb-8 border border-slate-200 rounded-2xl">
                <div class="grid-calendar overflow-x-auto">
                    <table class="w-full text-xs border-collapse">
                        <thead>
                            <tr id="calendarHeader" class="bg-slate-50 border-b">
                                <th class="p-4 border-r sticky left-0 bg-slate-50 z-20 w-40 sm:w-56 text-left font-bold text-slate-700">COLABORADOR</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-8">
                <div class="kpi-card bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase">Total</p><h4 class="text-xl sm:text-2xl font-black" id="statTotal">0</h4></div>
                <div class="kpi-card bg-white p-4 rounded-2xl border-l-4 border-l-red-400 shadow-sm"><p class="text-[10px] font-bold text-red-400 uppercase">Faltas</p><h4 class="text-xl sm:text-2xl font-black text-red-600" id="statFaltas">0</h4></div>
                <div class="kpi-card bg-white p-4 rounded-2xl border-l-4 border-l-green-400 shadow-sm"><p class="text-[10px] font-bold text-green-400 uppercase">Atestados</p><h4 class="text-xl sm:text-2xl font-black text-green-600" id="statAtestados">0</h4></div>
                <div class="kpi-card bg-white p-4 rounded-2xl border-l-4 border-l-blue-400 shadow-sm"><p class="text-[10px] font-bold text-blue-400 uppercase">Meio</p><h4 class="text-xl sm:text-2xl font-black text-blue-600" id="statMeio">0</h4></div>
            </div>

            <div class="flex justify-end mb-4">
                <button onclick="toggleDataLabels()" id="btnLabels" class="text-[10px] font-bold px-4 py-2 bg-slate-200 rounded-lg text-slate-600 hover:bg-slate-300 transition-all uppercase tracking-widest">
                    Exibir N√∫meros: OFF
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 pb-10">
                <div class="bg-white p-4 rounded-2xl border shadow-sm h-80 sm:h-[450px]"><canvas id="colabBarChart"></canvas></div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm h-80 sm:h-[450px]"><canvas id="sectorBarChart"></canvas></div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm h-80 sm:h-[450px]"><canvas id="pieChart"></canvas></div>
            </div>
        </div>

        <div id="colaboradores" class="tab-content hidden">
            <div class="bg-white p-4 sm:p-8 rounded-3xl shadow-xl border border-slate-200 max-w-5xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                    <h2 class="text-2xl font-black text-slate-800">Equipe</h2>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="openPasswordModal()" class="flex-1 sm:flex-none bg-red-50 text-red-600 text-[10px] font-bold px-4 py-2 rounded-xl border border-red-200">LIMPAR PER√çODO</button>
                        <span id="countEquipe" class="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-xl uppercase">Total: 0</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-8 bg-slate-50 p-4 rounded-2xl border border-dashed">
                    <input type="hidden" id="editId">
                    <input type="text" id="nome" placeholder="NOME" class="uppercase-input border p-3 rounded-xl text-sm" oninput="this.value = this.value.toUpperCase()">
                    <input type="text" id="setor" placeholder="SETOR" class="uppercase-input border p-3 rounded-xl text-sm" oninput="this.value = this.value.toUpperCase()">
                    <input type="text" id="usuario" placeholder="USU√ÅRIO" class="uppercase-input border p-3 rounded-xl text-sm" oninput="this.value = this.value.toUpperCase()">
                    <button onclick="saveEmployee()" id="btnSave" class="bg-slate-900 text-white rounded-xl font-bold p-3">SALVAR</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <input type="text" id="searchEquipe" oninput="renderTable()" placeholder="Filtrar Nome ou Usu√°rio..." class="flex-grow p-3 bg-white border rounded-xl text-sm shadow-sm">
                    <select id="filterEquipeSetor" onchange="renderTable()" class="p-3 bg-white border rounded-xl text-sm shadow-sm"></select>
                </div>
                <div class="overflow-x-auto rounded-xl border">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900 text-white text-[10px] uppercase"><tr>
                            <th class="p-4">Colaborador</th><th class="p-4">Setor</th><th class="p-4">Usu√°rio</th><th class="p-4 text-center">A√ß√µes</th>
                        </tr></thead>
                        <tbody id="employeeTableBody" class="divide-y bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modalOcorrencia" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-black text-slate-800 mb-1" id="modalTitle">Lan√ßar Registro</h3>
            <p id="modalSubtitle" class="text-xs text-blue-600 mb-6 font-bold"></p>
            <div class="space-y-4">
                <select id="motivo" class="border-2 p-3 rounded-xl w-full bg-slate-50 font-bold outline-none">
                    <option value="">‚úÖ PRESENTE</option>
                    <option value="Falta">‚ùå FALTA</option>
                    <option value="Atestado">üè• ATESTADO</option>
                    <option value="Declara√ß√£o">üìÑ DECLARA√á√ÉO</option>
                    <option value="Meio Expediente">üïí MEIO PER√çODO</option>
                </select>
                <textarea id="comentario" rows="3" class="border-2 p-3 rounded-xl w-full text-sm outline-none" placeholder="Observa√ß√µes..."></textarea>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeModal()" class="flex-1 bg-slate-100 py-4 rounded-2xl font-bold text-slate-500">CANCELAR</button>
                    <button onclick="confirmOcorrencia()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">SALVAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG SUPABASE
        const _URL = "https://gdvevopihqxwfcvzwjkv.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkdmV2b3BpaHF4d2Zjdnp3amt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjg4MjMsImV4cCI6MjA4Njg0NDgyM30.d6yJeghj1OJC36A6sb9kBP903pz2i2jhpC2BMaL0Ekw";
        const sb = supabase.createClient(_URL, _KEY);

        Chart.register(ChartDataLabels);

        let employees = [];
        let ocorrencias = [];
        let currentModalData = null;
        let colabBarChart, pieChart, sectorBarChart;
        let showLabels = false;

        async function init() {
            resetDashDates();
            await fetchData();
            renderTable();
            buildCalendar();
        }

        async function fetchData(dataInicio, dataFim) {
            const { data: colabs, error: err1 } = await sb.from('colaboradores').select('*').order('nome');
            let query = sb.from('ocorrencias').select('*');
            if (dataInicio && dataFim) {
                query = query.gte('data', dataInicio).lte('data', dataFim);
            }
            const { data: ocors, error: err2 } = await query;
            if(err1 || err2) return showToast("‚ùå Erro ao conectar banco");
            
            employees = colabs || [];
            ocorrencias = (ocors || []).map(o => {
                const emp = employees.find(e => e.id === o.colaborador_id);
                return {
                    id: o.id,
                    colab: emp?.nome,
                    setor: emp?.setor,
                    colabId: o.colaborador_id,
                    data: o.data,
                    motivo: o.motivo,
                    comentario: o.comentario
                }
            });
            populateSectorFilter();
            showToast("‚úÖ Cloud Sincronizado");
        }

        function toggleDataLabels() {
            showLabels = !showLabels;
            document.getElementById('btnLabels').innerText = `Exibir N√∫meros: ${showLabels ? 'ON' : 'OFF'}`;
            buildCalendar();
        }

        async function openDeleteModal(id) {
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                const { error } = await sb.from('colaboradores').delete().eq('id', id);
                if(error) return showToast("‚ùå Erro ao deletar");
                await fetchData();
                renderTable();
                buildCalendar();
                closeDeleteModal();
            };
        }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.add('hidden'); }

        async function saveEmployee() {
            const n = document.getElementById('nome').value, s = document.getElementById('setor').value, u = document.getElementById('usuario').value, id = document.getElementById('editId').value;
            if(!n || !s) return showToast("‚ö†Ô∏è Nome e Setor obrigat√≥rios!");
            let res;
            if(id === "") {
                res = await sb.from('colaboradores').insert([{ nome: n, setor: s, usuario: u }]);
            } else {
                res = await sb.from('colaboradores').update({ nome: n, setor: s, usuario: u }).eq('id', id);
                document.getElementById('editId').value = "";
                document.getElementById('btnSave').innerText = "SALVAR";
            }
            if(res.error) return showToast("‚ùå Erro ao salvar");
            document.getElementById('nome').value = ""; document.getElementById('setor').value = ""; document.getElementById('usuario').value = "";
            await fetchData();
            renderTable();
            buildCalendar();
        }

        function editEmployee(id) {
            const e = employees.find(emp => emp.id === id);
            document.getElementById('nome').value = e.nome;
            document.getElementById('setor').value = e.setor;
            document.getElementById('usuario').value = e.usuario;
            document.getElementById('editId').value = e.id;
            document.getElementById('btnSave').innerText = "ATUALIZAR";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function confirmOcorrencia() {
            const m = document.getElementById('motivo').value;
            const emp = employees.find(e => e.nome === currentModalData.nome);
            await sb.from('ocorrencias').delete().eq('colaborador_id', emp.id).eq('data', currentModalData.data);
            if(m !== "") {
                await sb.from('ocorrencias').insert([{
                    colaborador_id: emp.id,
                    data: currentModalData.data,
                    motivo: m,
                    comentario: document.getElementById('comentario').value
                }]);
            }
            closeModal();
            await fetchData(document.getElementById('filterStart').value, document.getElementById('filterEnd').value);
            buildCalendar();
        }

        async function verifyAndClear() {
            const pw = document.getElementById('inputSenha').value;
            if(pw !== "2001") return showToast("‚ö†Ô∏è Senha incorreta!");
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            await sb.from('ocorrencias').delete().gte('data', start).lte('data', end);
            await fetchData(start, end);
            buildCalendar();
            closePasswordModal();
        }

        function showToast(msg) {
            const toast = document.getElementById('customToast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function resetDashDates() {
            const now = new Date();
            document.getElementById('filterStart').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('filterEnd').value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        }

        function resetDashFilters() {
            document.getElementById('searchName').value = "";
            document.getElementById('filterSector').value = "";
            resetDashDates();
            buildCalendar();
        }

        function populateSectorFilter() {
            const unique = [...new Set(employees.map(e => e.setor))].sort();
            const options = '<option value="">Todos os Setores</option>' + unique.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('filterSector').innerHTML = options;
            document.getElementById('filterEquipeSetor').innerHTML = options;
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-tab-main').className = tabId === 'main' ? 'nav-btn nav-active' : 'nav-btn';
            document.getElementById('btn-tab-colaboradores').className = tabId === 'colaboradores' ? 'nav-btn nav-active' : 'nav-btn';
            if(tabId === 'main') buildCalendar();
        }

        async function buildCalendar() {
            const startVal = document.getElementById('filterStart').value;
            const endVal = document.getElementById('filterEnd').value;
            await fetchData(startVal, endVal);
            const header = document.getElementById('calendarHeader');
            const body = document.getElementById('calendarBody');
            const searchTerm = document.getElementById('searchName').value.toLowerCase();
            const sectorTerm = document.getElementById('filterSector').value;
            if(!startVal || !endVal) return;
            const dateRange = [];
            let curr = new Date(startVal + 'T00:00:00');
            const endLimit = new Date(endVal + 'T00:00:00');
            while(curr <= endLimit) { dateRange.push(new Date(curr)); curr.setDate(curr.getDate()+1); }
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
            header.innerHTML = '<th class="p-4 border-r sticky left-0 bg-slate-50 z-20 w-40 sm:w-56 text-left font-bold text-slate-700">COLABORADOR</th>';
            dateRange.forEach(d => { 
                header.innerHTML += `<th class="border-r p-2 w-10 text-center"><div class="flex flex-col items-center"><span>${d.getDate()}</span><span class="text-[9px] font-normal text-slate-400 uppercase">${diasSemana[d.getDay()]}</span></div></th>`; 
            });
            const filteredEmps = employees.filter(e => e.nome.toLowerCase().includes(searchTerm) && (sectorTerm === "" || e.setor === sectorTerm));
            body.innerHTML = '';
            filteredEmps.forEach(emp => {
                let row = `<tr><td class="p-4 border-r sticky left-0 bg-white font-semibold z-10 text-[10px] sm:text-xs">${emp.nome}</td>`;
                dateRange.forEach(d => {
                    const ds = d.toISOString().split('T')[0];
                    const oc = ocorrencias.find(o => o.colab === emp.nome && o.data === ds);
                    let cl = oc ? (oc.motivo === 'Falta' ? 'cell-falta' : oc.motivo === 'Atestado' ? 'cell-atestado' : oc.motivo === 'Declara√ß√£o' ? 'cell-declaracao' : 'cell-meio') : '';
                    row += `<td onclick="openModal('${emp.nome}', '${ds}')" class="border-r p-1 cursor-pointer ${cl}"></td>`;
                });
                body.innerHTML += row + '</tr>';
            });
            updateCharts(startVal, endVal, filteredEmps);
        }

        function updateCharts(start, end, fEmps) {
            const names = fEmps.map(e => e.nome);
            const filtered = ocorrencias.filter(o => o.data >= start && o.data <= end && names.includes(o.colab));
            const motCounts = { 'Falta': 0, 'Atestado': 0, 'Declara√ß√£o': 0, 'Meio Expediente': 0 };
            filtered.forEach(o => { if(motCounts[o.motivo] !== undefined) motCounts[o.motivo]++; });
            
            document.getElementById('statTotal').innerText = filtered.length;
            document.getElementById('statFaltas').innerText = motCounts['Falta'];
            document.getElementById('statAtestados').innerText = (motCounts['Atestado'] + motCounts['Declara√ß√£o']);
            document.getElementById('statMeio').innerText = motCounts['Meio Expediente'];

            if (colabBarChart) colabBarChart.destroy();
            if (pieChart) pieChart.destroy();
            if (sectorBarChart) sectorBarChart.destroy();

            const listColabs = names.map(n => {
                const colabOcors = filtered.filter(o => o.colab === n);
                const ausencias = colabOcors.filter(o => o.motivo !== 'Meio Expediente').length;
                const meio = colabOcors.filter(o => o.motivo === 'Meio Expediente').length;
                return { nome: n, ausencias, meio, total: ausencias + meio };
            }).sort((a, b) => b.total - a.total);

            colabBarChart = new Chart(document.getElementById('colabBarChart'), {
                type: 'bar',
                data: {
                    labels: listColabs.map(d => d.nome),
                    datasets: [
                        { label: 'Aus√™ncias', data: listColabs.map(d => d.ausencias), backgroundColor: '#ef4444', borderRadius: 4 },
                        { label: 'Meio Per√≠odo', data: listColabs.map(d => d.meio), backgroundColor: '#3b82f6', borderRadius: 4 }
                    ]
                },
                options: {
                    maintainAspectRatio: false, 
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: { 
                        title: { display: true, text: 'REGISTROS POR COLABORADOR' }, 
                        datalabels: { display: showLabels, color: '#fff', formatter: (val) => val > 0 ? val : '' } 
                    }
                }
            });

            const sectorData = {};
            filtered.forEach(o => { if(o.setor) sectorData[o.setor] = (sectorData[o.setor] || 0) + 1; });
            const sortedSectors = Object.entries(sectorData).sort((a,b) => b[1] - a[1]);

            sectorBarChart = new Chart(document.getElementById('sectorBarChart'), {
                type: 'bar',
                data: {
                    labels: sortedSectors.map(d => d[0]),
                    datasets: [{ label: 'Registros por Setor', data: sortedSectors.map(d => d[1]), backgroundColor: '#8b5cf6', borderRadius: 4 }]
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { title: { display: true, text: 'RANKING POR SETOR' }, datalabels: { display: showLabels, color: '#fff' } }
                }
            });

            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(motCounts), datasets: [{ data: Object.values(motCounts), backgroundColor: ['#fca5a5', '#6ee7b7', '#fde047', '#93c5fd'] }] },
                options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'DISTRIBUI√á√ÉO POR MOTIVO' }, datalabels: { display: showLabels } } }
            });
        }

        function renderTable() {
            const search = document.getElementById('searchEquipe').value.toLowerCase();
            const sector = document.getElementById('filterEquipeSetor').value;
            const filtered = employees.filter(e => (e.nome.toLowerCase().includes(search) || (e.usuario && e.usuario.toLowerCase().includes(search))) && (sector === "" || e.setor === sector));
            document.getElementById('countEquipe').innerText = `Total: ${filtered.length}`;
            document.getElementById('employeeTableBody').innerHTML = filtered.map((e) => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4 font-bold uppercase text-xs">${e.nome}</td>
                    <td class="p-4 text-slate-500 uppercase text-xs">${e.setor}</td>
                    <td class="p-4 text-slate-500 uppercase text-xs">${e.usuario || '-'}</td>
                    <td class="p-4 text-center">
                        <button onclick="editEmployee('${e.id}')" class="text-blue-600 font-bold mr-3">EDITAR</button>
                        <button onclick="openDeleteModal('${e.id}')" class="text-red-400 font-bold">EXCLUIR</button>
                    </td>
                </tr>`).join('');
        }

        function openModal(nome, data) {
            currentModalData = { nome, data };
            const ex = ocorrencias.find(o => o.colab === nome && o.data === data);
            document.getElementById('modalTitle').innerText = nome;
            document.getElementById('modalSubtitle').innerText = data;
            document.getElementById('motivo').value = ex ? ex.motivo : "";
            document.getElementById('comentario').value = ex ? ex.comentario : "";
            document.getElementById('modalOcorrencia').parentElement.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modalOcorrencia').parentElement.classList.add('hidden'); }
        function openPasswordModal() { document.getElementById('passwordModal').classList.remove('hidden'); }
        function closePasswordModal() { document.getElementById('passwordModal').classList.add('hidden'); document.getElementById('inputSenha').value = "";}

        function exportToPPT() {
            const originalLabelState = showLabels;
            showLabels = true;
            buildCalendar();
            setTimeout(() => {
                const pptx = new PptxGenJS();
                const start = document.getElementById('filterStart').value;
                let slide1 = pptx.addSlide(); slide1.background = { fill: "0F172A" };
                slide1.addText("RELAT√ìRIO DE ABSENTE√çSMO", { x: 1, y: 1.2, w: 8, h: 1, fontSize: 32, color: "60a5fa", bold: true, align: "center" });
                slide1.addText(`Per√≠odo inicial: ${start}`, { x: 1, y: 2.5, w: 8, h: 0.5, fontSize: 14, color: "FFFFFF", align: "center" });
                let slide2 = pptx.addSlide();
                slide2.addText("ESTAT√çSTICAS GERAIS", { x: 0.5, y: 0.2, fontSize: 20, bold: true });
                const barColab = document.getElementById('colabBarChart').toDataURL("image/png");
                const barSector = document.getElementById('sectorBarChart').toDataURL("image/png");
                slide2.addImage({ data: barColab, x: 0.5, y: 0.8, w: 4.2, h: 4 });
                slide2.addImage({ data: barSector, x: 5.2, y: 0.8, w: 4.2, h: 4 });
                let slide3 = pptx.addSlide();
                slide3.addText("DISTRIBUI√á√ÉO POR MOTIVO", { x: 0.5, y: 0.2, fontSize: 20, bold: true });
                const pieImage = document.getElementById('pieChart').toDataURL("image/png");
                slide3.addImage({ data: pieImage, x: 2.5, y: 0.8, w: 5, h: 4 });
                pptx.writeFile({ fileName: `Absenteismo_Cloud_${start}.pptx` });
                showLabels = originalLabelState;
                buildCalendar();
            }, 600);
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ocorrencias), "Ocorr√™ncias");
            XLSX.writeFile(wb, `Relatorio_Cloud.xlsx`);
        }

        init();
    </script>
</body>
</html>
